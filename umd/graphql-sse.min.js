!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).graphqlSse={})}(this,(function(e){"use strict";function t(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function r(e){return this instanceof r?(this.v=e,this):new r(e)}function n(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o,a=n.apply(e,t||[]),i=[];return o={},s("next"),s("throw"),s("return"),o[Symbol.asyncIterator]=function(){return this},o;function s(e){a[e]&&(o[e]=function(t){return new Promise((function(r,n){i.push([e,t,r,n])>1||l(e,t)}))})}function l(e,t){try{(n=a[e](t)).value instanceof r?Promise.resolve(n.value.v).then(c,f):u(i[0][2],n)}catch(e){u(i[0][3],e)}var n}function c(e){l("next",e)}function f(e){l("throw",e)}function u(e,t){e(t),i.shift(),i.length&&l(i[0][0],i[0][1])}}function o(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,n=e[Symbol.asyncIterator];return n?n.call(e):(e=t(e),r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r);function o(t){r[t]=e[t]&&function(r){return new Promise((function(n,o){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,o,(r=e[t](r)).done,r.value)}))}}}const a="x-graphql-event-stream-token";function i(e){if("next"!==e&&"complete"!==e)throw new Error(`Invalid stream event "${e}"`);return e}function s(e,t){if(t)try{t=JSON.parse(t)}catch(e){throw new Error("Invalid stream data")}if("next"===e&&!t)throw new Error('Stream data must be an object for "next" events');return t||null}var l;!function(e){e[e.NewLine=10]="NewLine",e[e.CchunkiageReturn=13]="CchunkiageReturn",e[e.Space=32]="Space",e[e.Colon=58]="Colon"}(l||(l={}));class c extends Error{constructor(e){let t,r;var n;(function(e){return"object"==typeof e&&null!==e})(n=e)&&"boolean"==typeof n.ok&&"number"==typeof n.status&&"string"==typeof n.statusText?(r=e,t="Server responded with "+e.status+": "+e.statusText):t=e instanceof Error?e.message:String(e),super(t),this.name=this.constructor.name,this.response=r}}async function f(e){const{signal:t,url:a,credentials:f,headers:u,body:d,referrer:h,referrerPolicy:y,fetchFn:w,onMessage:b}=e,v={},g={};let p;try{p=await w(a,{signal:t,method:d?"POST":"GET",reactNative:{textStreaming:!0},credentials:f,referrer:h,referrerPolicy:y,headers:Object.assign(Object.assign({},u),{accept:"text/event-stream"}),body:d})}catch(e){throw new c(e)}if(!p.ok)throw new c(p);if(!p.body)throw new Error("Missing response body");let x,m=null;return(async()=>{var e,t,a;try{const c=function(){let e,t,r,n=!1,o={event:"",data:""},a=[];const c=new TextDecoder;return function(f){if(void 0===e)e=f,t=0,r=-1;else{const t=new Uint8Array(e.length+f.length);t.set(e),t.set(f,e.length),e=t}const u=e.length;let d=0;for(;t<u;){n&&(e[t]===l.NewLine&&(d=++t),n=!1);let f=-1;for(;t<u&&-1===f;++t)switch(e[t]){case l.Colon:-1===r&&(r=t-d);break;case l.CchunkiageReturn:n=!0;case l.NewLine:f=t}if(-1===f)break;if(d===f){if(o.event||o.data){if(!o.event)throw new Error("Missing message event");const e=i(o.event),t=s(e,o.data);a.push({event:e,data:t}),o={event:"",data:""}}}else if(r>0){const t=e.subarray(d,f),n=c.decode(t.subarray(0,r)),a=r+(t[r+1]===l.Space?2:1),i=c.decode(t.subarray(a));switch(n){case"event":o.event=i;break;case"data":o.data=o.data?o.data+"\n"+i:i}}d=t,r=-1}if(d===u){e=void 0;const t=[...a];return a=[],t}0!==d&&(e=e.subarray(d),t-=d)}}();try{for(var f,u=o(function(e){if("function"==typeof Object(e)[Symbol.asyncIterator])return e[Symbol.asyncIterator]();return function(){return n(this,arguments,(function*(){const t=e.getReader();let n;do{n=yield r(t.read()),void 0!==n.value&&(yield yield r(n.value))}while(!n.done)}))}()}(p.body));!(f=await u.next()).done;){const e=f.value;if("string"==typeof e)throw m=new Error(`Unexpected string chunk "${e}"`);let t;try{t=c(e)}catch(e){throw m=e}if(t)for(const e of t){try{null==b||b(e)}catch(e){throw m=e}const t=e.data&&"id"in e.data?e.data.id:"";switch(t in g||(g[t]=[]),e.event){case"next":t?g[t].push(e.data.payload):g[t].push(e.data);break;case"complete":g[t].push("complete");break;default:throw m=new Error(`Unexpected message event "${e.event}"`)}null===(a=v[t])||void 0===a||a.proceed()}}}catch(t){e={error:t}}finally{try{f&&!f.done&&(t=u.return)&&await t.call(u)}finally{if(e)throw e.error}}if(Object.keys(v).length)throw new Error("Connection closed while having active streams")}catch(e){m=!m&&Object.keys(v).length?new c(e):e,null==x||x(m)}finally{Object.values(v).forEach((({proceed:e})=>e()))}})(),{url:a,headers:u,waitForThrow:()=>new Promise(((e,t)=>{if(m)return t(m);x=t})),getResults(e){var t;return n(this,arguments,(function*(){const{signal:n,operationId:o=""}=null!=e?e:{};try{for(;;){for(;null===(t=g[o])||void 0===t?void 0:t.length;){const e=g[o].shift();if("complete"===e)return yield r(void 0);yield yield r(e)}if(m)throw m;if(null==n?void 0:n.aborted)throw new Error("Getting results aborted by the client");yield r(new Promise((e=>{const t=()=>{null==n||n.removeEventListener("abort",t),delete v[o],e()};null==n||n.addEventListener("abort",t),v[o]={proceed:t}})))}}finally{delete g[o]}}))}}}e.NetworkError=c,e.TOKEN_HEADER_KEY=a,e.TOKEN_QUERY_KEY="token",e.createClient=function(e){const{singleConnection:t=!1,lazy:r=!0,lazyCloseTimeout:n=0,onNonLazyError:i=console.error,generateID:s=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},retryAttempts:l=5,retry:u=async function(e){let t=1e3;for(let r=0;r<e;r++)t*=2;await new Promise((e=>setTimeout(e,t+Math.floor(2700*Math.random()+300))))},credentials:d="same-origin",referrer:h,referrerPolicy:y,onMessage:w}=e,b=e.fetchFn||fetch,v=e.abortControllerImpl||AbortController,g=(()=>{let e=!1;const t=[];return{get disposed(){return e},onDispose:r=>e?(setTimeout((()=>r()),0),()=>{}):(t.push(r),()=>{t.splice(t.indexOf(r),1)}),dispose(){if(!e){e=!0;for(const e of[...t])e()}}}})();let p,x,m=0,E=null,S=0;async function T(){try{if(g.disposed)throw new Error("Client has been disposed");return await(null!=x?x:x=(async()=>{var t;if(E){if(await u(S),p.signal.aborted)throw new Error("Connection aborted by the client");S++}p=new v;const r=g.onDispose((()=>p.abort()));p.signal.addEventListener("abort",(()=>{r(),x=void 0}));const n="function"==typeof e.url?await e.url():e.url;if(p.signal.aborted)throw new Error("Connection aborted by the client");const o="function"==typeof e.headers?await e.headers():null!==(t=e.headers)&&void 0!==t?t:{};if(p.signal.aborted)throw new Error("Connection aborted by the client");let i;try{i=await b(n,{signal:p.signal,method:"PUT",credentials:d,referrer:h,referrerPolicy:y,headers:o})}catch(e){throw new c(e)}if(201!==i.status)throw new c(i);const s=await i.text();o[a]=s;const l=await f({signal:p.signal,headers:o,credentials:d,referrer:h,referrerPolicy:y,url:n,fetchFn:b,onMessage:w});return E=null,S=0,l.waitForThrow().catch((()=>x=void 0)),l})())}catch(e){throw x=void 0,e}}return t&&!r&&(async()=>{for(m++;;)try{const{waitForThrow:e}=await T();await e()}catch(e){if(g.disposed)return;if(!(e instanceof c))return null==i?void 0:i(e);if(x=void 0,!l||S>=l)return null==i?void 0:i(e);E=e}})(),{subscribe(a,i){if(!t){const t=new v,r=g.onDispose((()=>{r(),t.abort()}));return(async()=>{var r,n,s;let v=null,g=0;for(;;)try{if(v){if(await u(g),t.signal.aborted)throw new Error("Connection aborted by the client");g++}const l="function"==typeof e.url?await e.url():e.url;if(t.signal.aborted)throw new Error("Connection aborted by the client");const c="function"==typeof e.headers?await e.headers():null!==(s=e.headers)&&void 0!==s?s:{};if(t.signal.aborted)throw new Error("Connection aborted by the client");const{getResults:m}=await f({signal:t.signal,headers:c,credentials:d,referrer:h,referrerPolicy:y,url:l,body:JSON.stringify(a),fetchFn:b,onMessage:w});v=null,g=0;try{for(var p,x=(r=void 0,o(m()));!(p=await x.next()).done;){const e=p.value;i.next(e)}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=x.return)&&await n.call(x)}finally{if(r)throw r.error}}return t.abort()}catch(e){if(t.signal.aborted)return;if(!(e instanceof c))throw e;if(!l||g>=l)throw e;v=e}})().then((()=>i.complete())).catch((e=>i.error(e))),()=>t.abort()}m++;const O=new v,C=g.onDispose((()=>{C(),O.abort()}));return(async()=>{var e,t;const f=s();a=Object.assign(Object.assign({},a),{extensions:Object.assign(Object.assign({},a.extensions),{operationId:f})});let u=null;for(;;){u=null;try{const{url:r,headers:s,getResults:l}=await T();let x;try{x=await b(r,{signal:O.signal,method:"POST",credentials:d,referrer:h,referrerPolicy:y,headers:s,body:JSON.stringify(a)})}catch(e){throw new c(e)}if(202!==x.status)throw new c(x);u=async()=>{let e;try{const t=new v,n=g.onDispose((()=>{n(),t.abort()}));e=await b(r+"?operationId="+f,{signal:t.signal,method:"DELETE",credentials:d,referrer:h,referrerPolicy:y,headers:s})}catch(e){throw new c(e)}if(200!==e.status)throw new c(e)};try{for(var w,C=(e=void 0,o(l({signal:O.signal,operationId:f})));!(w=await C.next()).done;){const e=w.value;i.next(e)}}catch(t){e={error:t}}finally{try{w&&!w.done&&(t=C.return)&&await t.call(C)}finally{if(e)throw e.error}}return u=null,O.abort()}catch(e){if(O.signal.aborted)return await(null==u?void 0:u());if(!(e instanceof c))throw e;if(r&&(x=void 0),!l||S>=l)throw e;E=e}finally{O.signal.aborted&&0==--m&&(isFinite(n)&&n>0?setTimeout((()=>{m||p.abort()}),n):p.abort())}}})().then((()=>i.complete())).catch((e=>i.error(e))),()=>O.abort()},dispose(){g.dispose()}}},e.parseStreamData=s,e.validateStreamEvent=i,Object.defineProperty(e,"__esModule",{value:!0})}));
